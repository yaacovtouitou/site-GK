{% extends 'base.html.twig' %}

{% block title %}Paracha Connect - G√©oula Kids{% endblock %}

{% block body %}
<div class="space-y-6 max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
    {# Header & Progress #}
    <div class="text-center space-y-4">
        <h1 class="text-3xl sm:text-4xl font-bold gradient-text flex items-center justify-center gap-3">
            <span class="text-vibrant-orange">üìñ</span>
            Paracha Connect
        </h1>

        {# Torah Progress Bar #}
        <div class="glass-card rounded-[20px] p-4 max-w-3xl mx-auto">
            <div class="flex justify-between items-center mb-2 text-sm">
                <span class="font-bold text-royal-blue">Progression Annuelle</span>
                <span class="text-gold font-bold">{{ annualProgress|round }}%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                <div class="bg-gradient-to-r from-vibrant-orange to-gold h-full transition-all duration-1000 ease-out" style="width: {{ annualProgress }}%"></div>
            </div>

            <div class="flex gap-1 h-2 w-full mt-2 rounded-full overflow-hidden opacity-50">
                {% for book, count in torahBooks %}
                    {% set isCurrent = book == currentBook %}
                    <div class="flex-1 relative group cursor-help {{ isCurrent ? 'bg-royal-blue' : 'bg-gray-300' }}" title="{{ book }}"></div>
                {% endfor %}
            </div>

            <p class="text-xs text-gray-500 mt-2">
                Nous sommes dans le livre de <span class="font-bold text-royal-blue">{{ currentBook }}</span>, Paracha <span class="font-bold text-vibrant-orange">{{ currentParachaName }}</span>
            </p>
        </div>
    </div>

    {# Reader Interface #}
    <section class="glass-card rounded-[30px] overflow-hidden shadow-2xl border-4 border-white/50">
        {# Toolbar #}
        <div class="flex flex-wrap items-center justify-between gap-3 p-4 bg-white/80 border-b border-gray-200 backdrop-blur-sm">
            <div class="flex items-center gap-2">
                <span class="text-base sm:text-lg font-bold text-royal-blue truncate max-w-[200px] sm:max-w-none">{{ currentDocument.title }}</span>
            </div>

            <div class="flex items-center gap-2">
                <a href="{{ currentDocument.downloadUrl }}" target="_blank" class="puffy-button p-2 rounded-[10px] hover:scale-110 transition text-xs sm:text-sm" title="T√©l√©charger le PDF">
                    ‚¨áÔ∏è T√©l√©charger
                </a>
            </div>
        </div>

        {# PDF Viewer Area #}
        <div class="bg-gray-50 relative min-h-[500px] sm:min-h-[800px] flex flex-col items-center justify-center p-0">
            {# Native PDF Viewer #}
            <object data="{{ currentDocument.pdfUrl }}" type="application/pdf" width="100%" height="800px" class="rounded-b-[25px] w-full h-[500px] sm:h-[800px]">
                <div class="flex flex-col items-center justify-center h-full p-8 text-center">
                    <p class="text-gray-600 mb-4">Il semble que ton navigateur ne puisse pas afficher le PDF directement.</p>
                    <a href="{{ currentDocument.downloadUrl }}" target="_blank" class="puffy-button-primary px-6 py-3 rounded-[20px]">
                        T√©l√©charger le fichier pour le lire
                    </a>
                </div>
            </object>

            {# Floating Action Button #}
            <div class="absolute bottom-4 right-4 sm:bottom-8 sm:right-8 z-10">
                <button id="complete-reading-btn" class="puffy-button-gold px-4 py-2 sm:px-6 sm:py-3 rounded-[20px] font-bold shadow-lg hover:scale-105 transition flex items-center gap-2 animate-bounce border-2 border-white cursor-pointer text-sm sm:text-base">
                    <span>‚úÖ</span> J'ai termin√© la lecture !
                </button>
            </div>
        </div>
    </section>
</div>

{# Celebration Pop-up #}
<div id="celebration-modal" class="fixed inset-0 z-50 flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-300 px-4">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>
    <div class="bg-white rounded-[30px] p-6 sm:p-8 text-center shadow-2xl transform scale-90 transition-transform duration-300 border-4 border-gold w-full max-w-sm relative z-10">
        <div class="text-5xl sm:text-6xl mb-4 animate-bounce" id="modal-icon">üéâ</div>
        <h3 class="text-xl sm:text-2xl font-bold text-royal-blue mb-2" id="modal-title">Hazak !</h3>
        <p class="text-sm sm:text-base text-gray-600 mb-4" id="modal-message">Tu as bien √©tudi√© la Paracha !</p>
        <div class="inline-block bg-gold/20 text-gold font-bold px-4 py-2 sm:px-6 sm:py-2 rounded-full text-lg sm:text-xl" id="modal-points-badge">
            +<span id="modal-points">50</span> pts
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const completeBtn = document.getElementById('complete-reading-btn');
        const modal = document.getElementById('celebration-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalPoints = document.getElementById('modal-points');
        const modalPointsBadge = document.getElementById('modal-points-badge');
        const modalIcon = document.getElementById('modal-icon');

        completeBtn.addEventListener('click', function() {
            completeBtn.disabled = true;
            completeBtn.classList.add('opacity-50', 'cursor-not-allowed');
            completeBtn.classList.remove('animate-bounce');
            completeBtn.innerHTML = '<span>‚è≥</span> Validation...';

            fetch('/api/library/complete', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    return response.json().then(data => {
                        if (!response.ok) {
                            throw new Error(data.message || 'Erreur serveur');
                        }
                        return data;
                    });
                } else {
                    return response.text().then(text => {
                        console.error("Non-JSON response:", text);
                        throw new Error("Erreur serveur (HTML). V√©rifiez les logs.");
                    });
                }
            })
            .then(data => {
                if (data.success) {
                    completeBtn.innerHTML = '<span>‚ú®</span> Bravo !';
                    showCelebration(data.pointsEarned, true);
                } else if (data.alreadyCompleted) {
                    completeBtn.innerHTML = '<span>‚úÖ</span> D√©j√† fait';
                    showCelebration(0, false, data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                completeBtn.disabled = false;
                completeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                completeBtn.innerHTML = '<span>‚ùå</span> Erreur';
                alert("Erreur : " + error.message);
            });
        });

        function showCelebration(points, isSuccess, message = null) {
            if (isSuccess) {
                modalTitle.textContent = "Hazak !";
                modalMessage.textContent = "Tu as bien √©tudi√© la Paracha !";
                modalPoints.textContent = points;
                modalPointsBadge.style.display = 'inline-block';
                modalIcon.textContent = "üéâ";
                createConfetti();
            } else {
                modalTitle.textContent = "D√©j√† valid√© !";
                modalMessage.textContent = message || "Tu as d√©j√† gagn√© tes points cette semaine.";
                modalPointsBadge.style.display = 'none';
                modalIcon.textContent = "üìÖ";
            }

            modal.classList.remove('pointer-events-none', 'opacity-0');

            setTimeout(() => {
                modal.classList.add('opacity-0', 'pointer-events-none');
            }, 3000);
        }

        function createConfetti() {
            for(let i=0; i<30; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('fixed', 'w-3', 'h-3', 'z-50');
                confetti.style.backgroundColor = ['#FFD700', '#FF6B35', '#4169E1'][Math.floor(Math.random()*3)];
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.top = '-10px';
                confetti.style.transition = 'top 2s ease-out, transform 2s linear';
                document.body.appendChild(confetti);

                setTimeout(() => {
                    confetti.style.top = '100vh';
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                }, 10);

                setTimeout(() => confetti.remove(), 2000);
            }
        }
    });
</script>
{% endblock %}
